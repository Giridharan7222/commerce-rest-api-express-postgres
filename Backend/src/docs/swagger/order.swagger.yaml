paths:
  /api/orders:
    post:
      summary: Create order from cart
      tags: [Orders]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - shippingAddress
              properties:
                shippingAddress:
                  $ref: "#/components/schemas/ShippingAddress"
                paymentMethod:
                  type: string
                  example: "credit_card"
      responses:
        "201":
          description: Order created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Order created successfully"
                  data:
                    type: object
                    properties:
                      order:
                        $ref: "#/components/schemas/Order"
                      invoice:
                        $ref: "#/components/schemas/Invoice"
                      stripeCustomerId:
                        type: string
                        example: "cus_stripe_customer_id"
                      paymentIntent:
                        type: object
                        properties:
                          id:
                            type: string
                            example: "pi_stripe_payment_intent_id"
                          client_secret:
                            type: string
                            example: "pi_xxx_secret_xxx"
        "400":
          description: Validation error or cart is empty
        "401":
          description: Unauthorized

    get:
      summary: Get order history
      tags: [Orders]
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: page
          schema:
            type: integer
            minimum: 1
            default: 1
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 10
      responses:
        "200":
          description: Order history retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Order history retrieved successfully"
                  data:
                    type: object
                    properties:
                      orders:
                        type: array
                        items:
                          $ref: "#/components/schemas/OrderWithDetails"
                      pagination:
                        $ref: "#/components/schemas/Pagination"
        "401":
          description: Unauthorized

  /api/orders/{orderId}:
    get:
      summary: Get order by ID
      tags: [Orders]
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: orderId
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Order retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Order retrieved successfully"
                  data:
                    $ref: "#/components/schemas/OrderWithDetails"
        "404":
          description: Order not found
        "401":
          description: Unauthorized

  /api/orders/{orderId}/cancel:
    patch:
      summary: Cancel order
      tags: [Orders]
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: orderId
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Order cancelled successfully
        "400":
          description: Order cannot be cancelled
        "404":
          description: Order not found
        "401":
          description: Unauthorized

  /api/orders/{orderId}/complete-payment:
    patch:
      summary: Complete payment for order
      tags: [Orders]
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: orderId
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Payment completed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Payment completed successfully"
                  data:
                    $ref: "#/components/schemas/Order"
        "400":
          description: Payment already completed or order cancelled
        "404":
          description: Order not found
        "401":
          description: Unauthorized

  /api/orders/{orderId}/status:
    patch:
      summary: Update order status (Admin only)
      tags: [Orders]
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: orderId
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - status
              properties:
                status:
                  type: string
                  enum: [pending, processing, shipped, delivered, cancelled]
                  example: "processing"
      responses:
        "200":
          description: Order status updated successfully
        "400":
          description: Invalid status or validation error
        "404":
          description: Order not found
        "401":
          description: Unauthorized
        "403":
          description: Access denied

components:
  schemas:
    ShippingAddress:
      type: object
      required:
        - full_name
        - phone
        - address_line1
        - city
        - state
        - pincode
        - country
      properties:
        full_name:
          type: string
          example: "John Doe"
        phone:
          type: string
          example: "+1234567890"
        address_line1:
          type: string
          example: "123 Main Street"
        address_line2:
          type: string
          example: "Apt 4B"
        city:
          type: string
          example: "New York"
        state:
          type: string
          example: "NY"
        pincode:
          type: string
          example: "10001"
        country:
          type: string
          example: "USA"

    Order:
      type: object
      properties:
        id:
          type: string
          format: uuid
        user_id:
          type: string
          format: uuid
        total_amount:
          type: number
          format: decimal
        status:
          type: string
          enum: [pending, processing, shipped, delivered, cancelled]
        payment_status:
          type: string
          enum: [pending, paid, failed, cancelled]
        payment_method:
          type: string
        shipping_address:
          $ref: "#/components/schemas/ShippingAddress"
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    OrderItem:
      type: object
      properties:
        id:
          type: string
          format: uuid
        order_id:
          type: string
          format: uuid
        product_id:
          type: string
          format: uuid
        quantity:
          type: integer
        price_at_order_time:
          type: number
          format: decimal
        product:
          type: object
          properties:
            id:
              type: string
              format: uuid
            name:
              type: string
            description:
              type: string
            image_url:
              type: string

    OrderWithDetails:
      allOf:
        - $ref: "#/components/schemas/Order"
        - type: object
          properties:
            items:
              type: array
              items:
                $ref: "#/components/schemas/OrderItem"
            invoice:
              type: object
              properties:
                id:
                  type: string
                  format: uuid
                invoice_number:
                  type: string
                status:
                  type: string
                total_amount:
                  type: number
            transactions:
              type: array
              items:
                type: object
                properties:
                  id:
                    type: string
                    format: uuid
                  status:
                    type: string
                  payment_method:
                    type: string
                  amount:
                    type: number

    Invoice:
      type: object
      properties:
        id:
          type: string
          format: uuid
        invoice_number:
          type: string
        order_id:
          type: string
          format: uuid
        user_id:
          type: string
          format: uuid
        sub_total:
          type: number
          format: decimal
        tax_amount:
          type: number
          format: decimal
        discount_amount:
          type: number
          format: decimal
        total_amount:
          type: number
          format: decimal
        currency:
          type: string
          example: "INR"
        status:
          type: string
          enum: [generated, paid, cancelled]
        issued_at:
          type: string
          format: date-time
        paid_at:
          type: string
          format: date-time
        created_at:
          type: string
          format: date-time

    Pagination:
      type: object
      properties:
        currentPage:
          type: integer
          example: 1
        totalPages:
          type: integer
          example: 5
        totalOrders:
          type: integer
          example: 47
        hasNext:
          type: boolean
          example: true
        hasPrev:
          type: boolean
          example: false
